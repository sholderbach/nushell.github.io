import{_ as e,M as o,p as c,q as l,Q as n,t as s,N as t,a1 as p}from"./framework-344bb0e4.js";const u={},i=p(`<h1 id="plugins" tabindex="-1"><a class="header-anchor" href="#plugins" aria-hidden="true">#</a> Plugins</h1><h2 id="protocol" tabindex="-1"><a class="header-anchor" href="#protocol" aria-hidden="true">#</a> Protocol</h2><p>Plugins use JSON-RPC over stdin/stdout (much in the same way VSCode plugins do). The protocol is split into two stages.</p><p>The first stage of the protocol deals with the initial discovery of the plugin. A plugin is started up and then asked to reply with its configuration. Much the same was as commands, plugins have a signature that they respond to Nu with. Once Nu has this signature, it knows how to later invoke the plugin to do work.</p><p>The second stage is the actual doing of work. Here the plugins are sent either a stream of data where they act over the stream element-wise as a filter, or they take all the elements at once in a final processing step as a sink.</p><h2 id="discovery" tabindex="-1"><a class="header-anchor" href="#discovery" aria-hidden="true">#</a> Discovery</h2><p>Nu discovers plugins by checking all directories specified by <code>plugin_dirs</code> config entry and the directory where <code>nu</code> executable lies. You can change the configuration by executing <code>config set plugin_dirs [&quot;/path&quot;,&quot;/to&quot;,&quot;/search&quot;]</code> in Nu. In each directory, Nu is looking for executable files that match the pattern <code>nu_plugin_*</code> where <code>*</code> is a minimum of one alphanumeric character. On Windows, this has a similar pattern of <code>nu_plugin_*.exe</code> or <code>nu_plugin_*.bat</code>.</p><p>Once a matching file has been discovered, Nu will invoke the file and pass to it the first JSON-RPC command: config. Config replies with the signature of the plugin, which is identical to the signature commands use.</p><p>Nu continues in this way until it has traveled across all directories in the path.</p><p>After it has traversed the path, it will look in two more directories: the target/debug and the target/release directories. It will pick one or the other depending whether Nu was compiled in debug mode or release mode, respectively. This allows for easier testing of plugins during development.</p><h2 id="creating-a-plugin-in-rust" tabindex="-1"><a class="header-anchor" href="#creating-a-plugin-in-rust" aria-hidden="true">#</a> Creating a plugin (in Rust)</h2><p>In this section, we&#39;ll walk through creating a Nu plugin using Rust.</p><p>Let&#39;s create our project. For this example, we&#39;ll create a simple <code>len</code> command which will return the length of strings it&#39;s passed.</p><p>First off, we&#39;ll create our plugin:</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; cargo new nu_plugin_len
&gt; cd nu_plugin_len
</code></pre></div><p>Next, we&#39;ll add <code>nu</code> to the list of dependencies to the Cargo.toml directory. At the bottom of the new Cargo.toml file, add this new dependency on the <code>nu</code> crate:</p><div class="language-text" data-ext="text"><pre class="language-text"><code>[dependencies]
nu-plugin = &quot;~0&quot;
nu-protocol = &quot;~0&quot;
nu-source = &quot;~0&quot;
nu-errors = &quot;~0&quot;
</code></pre></div><p>With this, we can open up src/main.rs and create our plugin.</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">nu_errors<span class="token punctuation">::</span></span><span class="token class-name">ShellError</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_plugin<span class="token punctuation">::</span></span><span class="token punctuation">{</span>serve_plugin<span class="token punctuation">,</span> <span class="token class-name">Plugin</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_protocol<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">CallInfo</span><span class="token punctuation">,</span> <span class="token class-name">Primitive</span><span class="token punctuation">,</span> <span class="token class-name">ReturnSuccess</span><span class="token punctuation">,</span> <span class="token class-name">ReturnValue</span><span class="token punctuation">,</span> <span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Len</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecognized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">serve_plugin</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Len</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>There are a few moving parts here, so let&#39;s break them down one by one.</p><p>First off, let&#39;s look at main:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">serve_plugin</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Len</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In main, we just call a single function <code>serve_plugin</code>. This will do the work of calling into our plugin, handling the JSON serialization/deserialization, and sending values and errors back to Nu for us. To start it up, we pass it something that implements the <code>Plugin</code> trait.</p><p>Next, above main, is this implementation of the <code>Plugin</code> trait for our particular plugin. Here, we&#39;ll implement the Plugin trait for our type, Len, which we&#39;ll see more of soon. Let&#39;s take a look at how we implement this trait:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The two most important parts of this implementation are the <code>config</code> part, which is run by Nu when it first starts up. This tells Nu the basic information about the plugin: its name, the parameters it takes, the description, and what kind of plugin it is. Here, we tell Nu that the name is &quot;len&quot;, give it a basic description for <code>help</code> to display and that we are a filter plugin (rather than a sink plugin).</p><p>Next, in the <code>filter</code> implementation, we describe how to do work as values flow into this plugin. Here, we receive one value (a <code>Value</code>) at a time. We also return either a Vec of values or an error. Returning a Vec instead of a single value allows us to remove values, or add new ones, in addition to working with the single value coming in.</p><p>Because <code>begin_filter</code> doesn&#39;t do anything, we can remove it. This would make the above:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If that&#39;s the case, why have a <code>begin_filter</code>? Let&#39;s look at the signature of <code>begin_filter</code> a little closer:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Our <code>Len</code> command doesn&#39;t require any parameters, but if it did this is where we&#39;d get them. From here, we could configure our filter, and then use that with each step in of the <code>filter</code> command over the input.</p><p>Next, let&#39;s look at <code>Len</code> itself to see what it&#39;s doing:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Len</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecognized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We create a very simple <code>Len</code>, in fact, it has no structure at all. Instead, it&#39;s just a placeholder that will let us implement the plugin.</p><p>From here, we create two methods:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The first method is optional, it&#39;s just a convenient way to create a new value of the <code>Len</code> type. The real work is done in the second method:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecognized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This method will act over each element in the pipeline as it flows into our plugin. For our plugin, we really only care about strings so that we can return their length.</p><p>We use Rust&#39;s pattern matching to check the type of the Value coming in, and then operate with it if it&#39;s a string. The value is a <code>Tagged&lt;Value&gt;</code> so it carries with it where the value came from. If the value isn&#39;t a string, we give an error and let the user know where the value came from that is causing the problem. (Note, if we had wanted to also put an error underline under the command name, we could get the <code>name_span</code> from the CallInfo given to <code>begin_filter</code>)</p><p>Lastly, let&#39;s look at the top of the file:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">nu_errors<span class="token punctuation">::</span></span><span class="token class-name">ShellError</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_plugin<span class="token punctuation">::</span></span><span class="token punctuation">{</span>serve_plugin<span class="token punctuation">,</span> <span class="token class-name">Plugin</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_protocol<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">CallInfo</span><span class="token punctuation">,</span> <span class="token class-name">Primitive</span><span class="token punctuation">,</span> <span class="token class-name">ReturnSuccess</span><span class="token punctuation">,</span> <span class="token class-name">ReturnValue</span><span class="token punctuation">,</span> <span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Here we import everything we need -- types and functions -- to be able to create our plugin.</p><p>Once we have finished our plugin, to use it all we need to do is install it.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; cargo install --path .
</code></pre></div><p>Once <code>nu</code> starts up, it will discover the plugin and register it as a command. If you&#39;re already running <code>nu</code> during the installation process of your plugin, ensure you restart <code>nu</code> so that it can load and register your plugin.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; nu
&gt; hello | len
5
&gt; help len
This is my custom len plugin

Usage:
  &gt; len {flags}

flags:
  -h, --help: Display this help message
</code></pre></div><p><strong>Provides executing regular expressions</strong></p>`,49),k={href:"https://github.com/rust-lang/regex",target:"_blank",rel:"noopener noreferrer"},r=p(`<h2 id="creating-a-plugin-in-python" tabindex="-1"><a class="header-anchor" href="#creating-a-plugin-in-python" aria-hidden="true">#</a> Creating a plugin (in Python)</h2><p>We can also create plugins in other programming languages. In this section, we&#39;ll write the same <code>len</code> plugin in Python.</p><p>First, let&#39;s look at the full plugin:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> fileinput
<span class="token keyword">import</span> sys


<span class="token keyword">def</span> <span class="token function">print_good_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;jsonrpc&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;params&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_length</span><span class="token punctuation">(</span>string_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    string_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>string_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    int_item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">:</span> string_len<span class="token punctuation">}</span><span class="token punctuation">}</span>
    int_value <span class="token operator">=</span> string_value
    int_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> int_item
    <span class="token keyword">return</span> int_value


<span class="token keyword">for</span> line <span class="token keyword">in</span> fileinput<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    method <span class="token operator">=</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Return the length of a string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positional&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;named&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;is_filter&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        print_good_response<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;begin_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;filter&quot;</span><span class="token punctuation">:</span>
        int_item <span class="token operator">=</span> get_length<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Value&quot;</span><span class="token punctuation">:</span> int_item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;end_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>Note: there are ways to make the python more robust, but here we&#39;ve left it simple to help with explanations.</p><p>Let&#39;s look at how this plugin works, from the bottom to the top:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">for</span> line <span class="token keyword">in</span> fileinput<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    method <span class="token operator">=</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Return the length of a string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positional&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;named&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;is_filter&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        print_good_response<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;begin_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;filter&quot;</span><span class="token punctuation">:</span>
        int_item <span class="token operator">=</span> get_length<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Value&quot;</span><span class="token punctuation">:</span> int_item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;end_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>For this plugin, we have to serve two basic roles: responding to a request for the plugin configuration, and doing the actual filtering. This code acts as our main loop, responding to messages from Nu by doing some work and then returning a response. Each JSON message is sent to the plugin on a single line, so we need only to read the line and then parse the json it contains.</p><p>From there, we look at what method is being invoked. For this plugin, there are four methods we care about: config, begin_filter, filter, and end_filter. When we&#39;re sent a &#39;config&#39; request, we respond with the signature of this plugin, which is a bit of information to tell Nu how the command should be called. Once sent, we break out of the loop so that the plugin can exit and be later called when filtering begins.</p><p>The other three methods -- begin_filter, filter, and end_filter -- all work together to do the work of filtering the data coming in. As this plugin will work 1-to-1 with each bit of data, turning strings into their string lengths, we do most of our work in the <code>filter</code> method. The &#39;end_filter&#39; method here tells us it&#39;s time for the plugin to shut down, so we go ahead and break out of the loop.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_length</span><span class="token punctuation">(</span>string_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    string_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>string_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    int_item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">:</span> string_len<span class="token punctuation">}</span><span class="token punctuation">}</span>
    int_value <span class="token operator">=</span> string_value
    int_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> int_item
    <span class="token keyword">return</span> int_value
</code></pre></div><p>The work of filtering is done by the <code>get_length</code> function. Here, we assume we&#39;re given strings (we could make this more robust in the future and return errors otherwise), and then we extract the string we&#39;re given. From there, we measure the length of the string and create a new <code>Int</code> value for that length.</p><p>Finally, we use the same item we were given and replace the payload with this new Int. We do this to reuse the metadata that was passed to us with the string, though this is an optional step. We could have instead opted to create new metadata and passed that out instead.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">print_good_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;jsonrpc&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;params&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Each response from the plugin back to Nu is also a json message that is sent on a single line. We convert the response to json and send it out with this helper function.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> json
<span class="token keyword">import</span> fileinput
<span class="token keyword">import</span> sys
</code></pre></div><p>All of this takes a few imports to accomplish, so we make sure to include them.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
</code></pre></div><p>Finally, to make it easier to run our Python, we make this file executable (using something like <code>chmod +x nu_plugin_len</code>) and add the path to our python at the top. This trick works for Unix-based platforms, for Windows we would need to create an .exe or .bat file that would invoke the python code for us.</p><p>We are using Python 3 because Python 2 will not be maintained past 2020. However our script works accordingly with Python 2 and with Python 3. Just change the first line into:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python</span>
</code></pre></div><p>and you are good to go.</p><h2 id="creating-a-plugin-in-c" tabindex="-1"><a class="header-anchor" href="#creating-a-plugin-in-c" aria-hidden="true">#</a> Creating a plugin (in C#)</h2><p>You can learn about creating a Nu plugin with C# here:</p>`,24),d={href:"https://github.com/myty/nu-plugin-lib",target:"_blank",rel:"noopener noreferrer"};function g(h,m){const a=o("ExternalLinkIcon");return c(),l("div",null,[i,n("p",null,[s("We basically use the [regex]"),n("a",k,[s("https://github.com/rust-lang/regex"),t(a)]),s(" crate. Unless there is a specific reason, it is recommended to use it.")]),r,n("ul",null,[n("li",null,[n("a",d,[s(".Net Core nu-plugin-lib"),t(a)])])])])}const w=e(u,[["render",g],["__file","plugins.html.vue"]]);export{w as default};
