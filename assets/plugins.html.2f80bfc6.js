import{_ as n,z as s,A as a,a6 as t}from"./framework.3d018c9f.js";const p={},o=t(`<h1 id="plugins" tabindex="-1"><a class="header-anchor" href="#plugins" aria-hidden="true">#</a> Plugins</h1><h2 id="protocolo" tabindex="-1"><a class="header-anchor" href="#protocolo" aria-hidden="true">#</a> Protocolo</h2><p>Plugins usam JSON-RPC sobre stdin/stdout (de maneira parecida aos plugins do VSCode). O protocolo é dividido em dois estágios.</p><p>O primeiro estágio do protocolo lida com a descoberta inicial do plugin. Um plugin é iniciado e então solicitado para responder com a sua configuração. Muito semelhante aos comandos, plugins possuem uma assinatura que usam para responder ao Nu. Assim que o Nu possuir essa assinatura, ele saberá invocar o plugin futuramente.</p><p>O segundo estágio é a realização do verdadeiro trabalho. Aqui é enviado tanto uma stream de dados para o plugin agir em cada elemento como um filtro, ou então todos elementos de uma vez para o plugin agir em um processamento final como uma saída.</p><h2 id="descoberta" tabindex="-1"><a class="header-anchor" href="#descoberta" aria-hidden="true">#</a> Descoberta</h2><p>Nu descobre plugins ao checar todos os diretórios disponíveis no PATH atual. Em cada diretório, Nu busca por arquivos executáveis que combinam com o padrão <code>nu_plugin_*</code>, onde <code>*</code> é no mínimo um caracter alfanumérico. No Windows, isso é um padrão similar à <code>nu_plugin_*.exe</code> ou <code>nu_plugin_*.bat</code>.</p><p>Assim que um arquivo que combine com o padrão for descoberto, Nu vai invocar o arquivo e passar ao primeiro comando JSON-RPC: config. Config responde com a assinatura do plugin, que é idêntico a assinatura usada por comandos.</p><p>Nu continua essa busca até ter percorrido todos os diretórios no caminho.</p><p>Após ter percorrido o caminho, dois outros diretórios serão verificados o diretório alvo/debug e o diretório alvo/release. Um ou outro diretório vai ser buscado, dependendo seo Nu foi compilado no módo de depuração ou de release, respectivamente. Isso permite testar rapidamente os plugins durante o desenvolvimento.</p><h2 id="criando-um-plugin-em-rust" tabindex="-1"><a class="header-anchor" href="#criando-um-plugin-em-rust" aria-hidden="true">#</a> Criando um plugin (em Rust)</h2><p>Nessa seção, vamos mostrar como criar um plugin para o Nu usando Rust.</p><p>Vamos criar nosso projeto. Para esse exemplo, vamos criar um simples comando <code>len</code> que retorna o tamanho da string que recebe.</p><p>Primeiramente, vamos criar nosso plugin:</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; cargo new nu_plugin_len
&gt; cd nu_plugin_len
</code></pre></div><p>Então, vamos adicionar <code>nu</code> na lista de dependências do diretório Cargo.toml. No final do novo arquivo Cargo.toml, adicione essa nova dependência para o crate <code>nu</code>:</p><div class="language-text" data-ext="text"><pre class="language-text"><code>[dependencies]
nu-plugin = &quot;~0&quot;
nu-protocol = &quot;~0&quot;
nu-source = &quot;~0&quot;
nu-errors = &quot;~0&quot;
</code></pre></div><p>Com isso, podemos abrir src/main.rs e criar nosso plugin.</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">nu_errors<span class="token punctuation">::</span></span><span class="token class-name">ShellError</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_plugin<span class="token punctuation">::</span></span><span class="token punctuation">{</span>serve_plugin<span class="token punctuation">,</span> <span class="token class-name">Plugin</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_protocol<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">CallInfo</span><span class="token punctuation">,</span> <span class="token class-name">Primitive</span><span class="token punctuation">,</span> <span class="token class-name">ReturnSuccess</span><span class="token punctuation">,</span> <span class="token class-name">ReturnValue</span><span class="token punctuation">,</span> <span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Len</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecorgnized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">serve_plugin</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Len</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Existe bastante código até aqui, então vamos verificar cada trecho separadamente.</p><p>Primeiramente, vamos olhar o main:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">serve_plugin</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Len</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>No main, simplesmente chamamos uma única função <code>serve_plugin</code>. Isso vai fazer o trabalho de chamar o plugin, lidando com a serialização/desserialização do JSON, e enviando valores e erros de volta para o Nu. Para iniciá-lo, passamos algo que implementa a trait <code>Plugin</code>.</p><p>Em seguida, acima do main, está a implementação da trait <code>Plugin</code> para o nosso plugin em particular. Aqui, vamos implementar a trait Plugin para o nosso tipo, Len, que veremos em breve. Vamos ver como implementamos essa trait:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As duas partes mais importantes dessa implementação são a parte de <code>config</code>, que é executada pelo Nu quando se inicia pela primeira vez. Isso informa ao Nu as informações básicas sobre o plugin: nome, parâmetros recebidos, descrição e qual o tipo do plugin. Aqui, informamos ao Nu que o nome é &quot;len&quot;, damos uma básica descrição de <code>ajuda</code> para mostrar e que somos um plugin de filtro (ao invés de um plugin de saída).</p><p>Em seguida, na implementação do <code>filter</code>, descrevemos como as informações são processadas com o fluxo de dados neste plugin. Aqui, recebemos um valor (um <code>Value</code>) de cada vez. Também retornamos ou um Vec de valores ou um erro. Retornar um vec ao invés de um único valor nos permite remover valores, ou adicionar outros, além de trabalhar com o único valor recebido.</p><p>Já que o <code>begin_filter</code> não faz nada, podemos remove-lo. Isso simplificaria o código acima:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Plugin</span> <span class="token keyword">for</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;len&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;My custom len plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">ReturnSuccess</span><span class="token punctuation">::</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Se esse é o caso, por que temos um <code>begin_filter</code>? Vamos ver a assinatura do <code>begin_filter</code> mais próximo:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">begin_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> _<span class="token punctuation">:</span> <span class="token class-name">CallInfo</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">ReturnValue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nosso comando <code>Len</code> não requer nenhum parâmetro, mas caso precisasse esse seria o local para obtê-los. A partir daqui, podemos configurar nosso filtro, e então usar isso com cada passo do comando <code>filter</code> sobre a entrada.</p><p>Vamos verificar o próprio <code>Len</code> para ver o que ele está fazendo:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Len</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecorgnized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Criamos um <code>Len</code> muito simples, de fato, que não tem nenhuma estrutura. Ao invés disso é apenas um placeholder que vai permitir a implementação do plugin.</p><p>Daqui, criamos dois métodos:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
        <span class="token class-name">Len</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>O primeiro método é opcional: é apenas uma maneira conveniente de criar um novo valor do tipo <code>Len</code>. O verdadeiro trabalho é realizado no segundo método:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Len</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token class-name">ShellError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token operator">&amp;</span>value<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token class-name">Primitive</span><span class="token punctuation">(</span><span class="token class-name">Primitive</span><span class="token punctuation">::</span><span class="token class-name">String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Value</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">::</span><span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token punctuation">:</span> value<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ShellError</span><span class="token punctuation">::</span><span class="token function">labeled_error</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Unrecorgnized type in stream&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;&#39;len&#39; given non-string info by this&quot;</span><span class="token punctuation">,</span>
                value<span class="token punctuation">.</span>tag<span class="token punctuation">.</span>span<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Esse método age sobre cada elemento no pipeline que é recebido pelo nosso plugin. Para o nosso plugin, nos preocupamos apenas com strings para poder retornar o seu tamanho.</p><p>Usamos o pattern matching de Rust para verificar o tipo do Value recebido, e entã poderando com ele caso seja uma string. O valor é um <code>Tagged&lt;Value&gt;</code>, então ele armazena com ele de onde o valor surgiu. Se o valor não é um string, retornamos um erro e deixamos o usuário saber de onde veio o valor que está causando o problema. (Note que se quisessemos colocar um erro abaixo do nome do nome do comando, asta basta usar o <code>name_span</code> do CallInfo informado no <code>begin_filter</code>)</p><p>Por último, vamos ver o começo do arquivo:</p><div class="language-rust" data-ext="rs"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">nu_errors<span class="token punctuation">::</span></span><span class="token class-name">ShellError</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_plugin<span class="token punctuation">::</span></span><span class="token punctuation">{</span>serve_plugin<span class="token punctuation">,</span> <span class="token class-name">Plugin</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nu_protocol<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">CallInfo</span><span class="token punctuation">,</span> <span class="token class-name">Primitive</span><span class="token punctuation">,</span> <span class="token class-name">ReturnSuccess</span><span class="token punctuation">,</span> <span class="token class-name">ReturnValue</span><span class="token punctuation">,</span> <span class="token class-name">Signature</span><span class="token punctuation">,</span> <span class="token class-name">UntaggedValue</span><span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Aqui importamos tudo o que precisamos -- tipos e funções -- para ser possível criar nosso plugin.</p><p>Assim que acabarmos nosso plugin só precisamos instalá-lo para usá-lo.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; cargo install --path .
</code></pre></div><p>Assim que o <code>nu</code> iniciar, vai descobrir o plugin e registrá-lo como um comando. Se você já estiver executando o <code>nu</code> durante o processo de instalação do seu plugin, tenha certeza de que você reiniciou o <code>nu</code> para que possa carregar e registrar seu plugin.</p><div class="language-text" data-ext="text"><pre class="language-text"><code>&gt; nu
&gt; echo hello | len
5
&gt; help len
This is my custom len plugin

Usage:
  &gt; len {flags}

flags:
  -h, --help: Display this help message
</code></pre></div><h2 id="criando-um-plugin-em-python" tabindex="-1"><a class="header-anchor" href="#criando-um-plugin-em-python" aria-hidden="true">#</a> Criando um plugin (em Python)</h2><p>Podemos também criar plugins em outras linguagens de programação. Nessa seção, vamos escrever o mesmo plugin <code>len</code> em Python.</p><p>Primeiramente, vamos verificar o plugin completo:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> fileinput
<span class="token keyword">import</span> sys


<span class="token keyword">def</span> <span class="token function">print_good_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;jsonrpc&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;params&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_length</span><span class="token punctuation">(</span>string_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    string_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>string_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    int_item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">:</span> string_len<span class="token punctuation">}</span><span class="token punctuation">}</span>
    int_value <span class="token operator">=</span> string_value
    int_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> int_item
    <span class="token keyword">return</span> int_value


<span class="token keyword">for</span> line <span class="token keyword">in</span> fileinput<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    method <span class="token operator">=</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Return the length of a string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positional&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;named&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;is_filter&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        print_good_response<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;begin_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;filter&quot;</span><span class="token punctuation">:</span>
        int_item <span class="token operator">=</span> get_length<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Value&quot;</span><span class="token punctuation">:</span> int_item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;end_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>Nota: existem maneiras de tornar Python mais robusto, mas aqui deixamos de maneira simples para ajudar com explicações.</p><p>Vamos verificar como o plugin funciona, de baixa para cima:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">for</span> line <span class="token keyword">in</span> fileinput<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    method <span class="token operator">=</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">:</span>
        config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;len&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Return the length of a string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positional&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;named&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;is_filter&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        print_good_response<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;begin_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;filter&quot;</span><span class="token punctuation">:</span>
        int_item <span class="token operator">=</span> get_length<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Value&quot;</span><span class="token punctuation">:</span> int_item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">&quot;end_filter&quot;</span><span class="token punctuation">:</span>
        print_good_response<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
</code></pre></div><p>Para esse plugin, temos que servir a função básica: responder ao request da configuração do plugin a realizar o filtro. Esse código age como o loop principal, respondendo as mensagens do Nu realizando algum trabalho e então retornando uma resposta. Cada mensagem JSON é enviada para o plugin em uma única linha, então é necessário apenas ler a linha e realizar a interpretação do JSON contido.</p><p>A partir disso, vemos qual método é invocado. Para esse plugin, existem quatro métodos que nos preocupamos: config, begin_filter, filter, e end_filter. Quando recebemos um request do tipo &#39;config&#39;, respondemos com a assinatura desse plugin, que é um pedaço de informação dizendo ao Nu como o comando deve ser chamado. Assim que for enviado, saímos do loop para que o plugin possa encerrar e ser invocado novamente quando o filtro iniciar.</p><p>Os outros três métodos -- begin_filter, filter, e end_filter -- trabalham todos juntos para filtrar os dados recebidos. Como esse plugin vai trabalhar separadamente com cada pedaço de dado, transformando strings nos seus respectivos tamanhos, fazemos a maior parte do nosso trabalho no método <code>filter</code>. O método &#39;end_filter&#39; é usado para encerrar o plugin, então usamos ele para sair do loop.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_length</span><span class="token punctuation">(</span>string_value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    string_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>string_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    int_item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Primitive&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">:</span> string_len<span class="token punctuation">}</span><span class="token punctuation">}</span>
    int_value <span class="token operator">=</span> string_value
    int_value<span class="token punctuation">[</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> int_item
    <span class="token keyword">return</span> int_value
</code></pre></div><p>A filtragem é realizada pela função <code>get_length</code>. Aqui, assumimos que estamos recebendo strings (podemos fazer esse método mais robusto futuramente e retornar um erro caso o parâmetro não seja uma string), e então extraímos a string recebida. A partir disso, medimos o tamanho da string e criamos um novo <code>Int</code> para esse tamanho.</p><p>Finalmente, usamos o mesmo item recebido e o substituimos o payload com esse novo Int. Fazemos isso para reutilizar os metadados que passamos junto com a string recebida, apesar de isso ser um passo opcional. Poderíamos ter optado por criar novos metadados e passá-los como resposta.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">print_good_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    json_response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;jsonrpc&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;response&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;params&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_response<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Cada resposta do plugin para o Nu é também uma mensagem em JSON que é enviada em uma única linha. Convertemos essa resposta para JSON e enviamos com essa função auxiliar.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> json
<span class="token keyword">import</span> fileinput
<span class="token keyword">import</span> sys
</code></pre></div><p>Tudo isso requer alguns imports para suceder, então vamos ter certeza de incluí-los.</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python3</span>
</code></pre></div><p>Finalmente, para facilitar a execução de Python, torne esse arquivo executável (usando algo como <code>chmod +x nu_plugin_len</code>) e adicione o caminho para o nosso python no topo. Esse truque funciona para plataformas baseadas em Unix, mas para Windows vamos precisar criar um .exe ou .bat que vai invocar o python para nós.</p><p>Utilizamos Python 3 pois Python 2 não vai mais ser mantido após 2020. Entretanto, scripts funcionam em ambas as versões. Apenas mude a primeira linha da seguinte forma:</p><div class="language-python" data-ext="py"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python</span>
</code></pre></div><p>e você já pode utilizar.</p><h2 id="criando-um-plugin-em-c" tabindex="-1"><a class="header-anchor" href="#criando-um-plugin-em-c" aria-hidden="true">#</a> Criando um plugin (em C#)</h2><p>Você pode aprender mais sobre criar um plugin de Nu com C# aqui:</p><ul><li>.Net Core nu-plugin-lib: (https://github.com/myty/nu-plugin-lib)</li></ul>`,73),e=[o];function c(u,l){return s(),a("div",null,e)}const r=n(p,[["render",c],["__file","plugins.html.vue"]]);export{r as default};
